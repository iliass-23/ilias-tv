<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ILIAS-TV</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
  body {
    margin: 0;
    font-family: 'Roboto', sans-serif;
    background: linear-gradient(135deg, #1f1c2c, #4b3c69, #ff5ca2);
    color: #fff;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  header {
    text-align: center;
    padding: 25px 10px;
    font-size: 2.5rem;
    font-weight: 700;
    letter-spacing: 2px;
  }

  .menu, .channels {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 25px;
    padding: 25px;
    flex: 1;
    overflow-y: auto;
  }

  .item {
    background: rgba(255,255,255,0.05);
    backdrop-filter: blur(16px);
    border-radius: 24px;
    padding: 15px;
    text-align: center;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: transform 0.25s, background 0.25s;
    border: 1px solid rgba(255,255,255,0.12);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 140px;
  }

  .item img {
    width: 100px;
    height: 80px;
    border-radius: 12px;
    margin-bottom: 10px;
    object-fit: contain; /* show full logo */
    background: rgba(0,0,0,0.2);
  }

  .item i {
    font-size: 2.2rem;
    margin-bottom: 10px;
    color: #fff;
    opacity: 0.8;
  }

  .item:hover, .active {
    background: rgba(255,255,255,0.12);
    transform: scale(1.08);
    color: #000;
  }

  video {
    width: 95%;
    max-width: 1200px;
    margin: 30px auto;
    display: block;
    border-radius: 24px;
    background: black;
    border: 1px solid rgba(255,255,255,0.12);
  }

  button {
    display: block;
    margin: 20px auto;
    padding: 15px 30px;
    border-radius: 15px;
    border: none;
    background: rgba(255,255,255,0.1);
    color: #fff;
    font-weight: 700;
    cursor: pointer;
    font-size: 1.1rem;
    transition: background 0.25s, transform 0.2s;
  }

  button:hover {
    background: rgba(255,255,255,0.2);
    transform: scale(1.05);
    color: #000;
  }

  #loading {
    text-align: center;
    font-size: 1.4rem;
    padding: 15px;
  }

  footer {
    text-align: center;
    padding: 20px;
    background: rgba(0,0,0,0.25);
    font-size: 1rem;
  }

  footer span.heart {
    color: red;
  }

  .menu::-webkit-scrollbar, .channels::-webkit-scrollbar {
    width: 10px;
  }
  .menu::-webkit-scrollbar-thumb, .channels::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.2);
    border-radius: 5px;
  }
</style>
</head>
<body>

<header>ILIAS-TV</header>
<div id="app"></div>
<div id="loading" style="display:none;">Loading stream...</div>
<footer>ILIAS-TV | Made with <span class="heart">❤️</span> for Arabic TV lovers</footer>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
const playlistUrl = "https://iptv-org.github.io/iptv/languages/ara.m3u";
const app = document.getElementById("app");
const loading = document.getElementById("loading");
let data = {};
let focusIndex = 0;
let items = [];
let currentVideo = null;
let currentHls = null;

async function loadPlaylist() {
  try {
    const res = await fetch(playlistUrl);
    const text = await res.text();
    const lines = text.split(/\r?\n/);
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      if (line.startsWith("#EXTINF")) {
        const categoryMatch = line.match(/group-title="(.*?)"/);
        const category = categoryMatch ? categoryMatch[1] : "Other";
        const nameMatch = line.match(/,(.*)$/);
        const name = nameMatch ? nameMatch[1].trim() : "Unnamed";
        let url = lines[i + 1] ? lines[i + 1].trim() : null;
        if (!url || url.startsWith("#")) continue;
        const logoMatch = line.match(/tvg-logo="(.*?)"/);
        const logo = logoMatch ? logoMatch[1] : null;
        if (!data[category]) data[category] = [];
        data[category].push({ name, url, logo });
      }
    }
    showCategories();
  } catch (err) {
    app.innerHTML = "<p style='text-align:center;color:red;'>Failed to load playlist.</p>";
    console.error(err);
  }
}

function showCategories() {
  stopCurrentVideo();
  app.innerHTML = "<div class='menu'>" +
    Object.keys(data).map(c => `<div class='item' onclick="showChannels('${c}')"><i class='fas fa-tv'></i>${c}</div>`).join("") +
    "</div>";
  focusIndex = 0;
  updateFocus();
}

function showChannels(category) {
  stopCurrentVideo();
  app.innerHTML = `<h2 style="text-align:center;margin-top:20px;">${category}</h2>
    <div class='channels'>` +
    data[category].map(ch => `<div class='item'>${ch.logo ? `<img src="${ch.logo}">` : `<i class='fas fa-play-circle'></i>`}${ch.name}</div>`).join("") +
    `</div>
    <button onclick='showCategories()'>⬅ Back</button>`;
  
  data[category].forEach((ch, idx) => {
    document.querySelectorAll('.channels .item')[idx].onclick = () => playChannel(ch.url);
  });

  focusIndex = 0;
  updateFocus();
}

function playChannel(url) {
  stopCurrentVideo();
  app.innerHTML = `<video id="video" controls autoplay></video>
                   <button onclick='showCategories()'>⬅ Back</button>`;
  const video = document.getElementById("video");
  currentVideo = video;
  loading.style.display = "block";

  if (Hls.isSupported()) {
    currentHls = new Hls({
      lowLatencyMode: false,
      maxBufferLength: 60,
      maxMaxBufferLength: 120,
      maxBufferSize: 60*1000*1000,
      maxBufferHole: 1,
      autoStartLoad: true,
      startPosition: -1
    });
    currentHls.loadSource(url);
    currentHls.attachMedia(video);
    currentHls.on(Hls.Events.MANIFEST_PARSED, () => { loading.style.display="none"; video.play(); });
    currentHls.on(Hls.Events.FRAG_LOADED, () => { if(video.paused) video.play(); });
    currentHls.on(Hls.Events.ERROR, (event,data) => {
      if(data.fatal){ currentHls.destroy(); setTimeout(()=>playChannel(url), 1000); }
    });
  } else if(video.canPlayType('application/vnd.apple.mpegurl')){
    video.src = url;
    video.addEventListener('loadedmetadata', ()=>{loading.style.display="none"; video.play();});
  } else {
    alert("Cannot play this stream"); loading.style.display="none";
  }
  video.requestFullscreen?.();
}

function stopCurrentVideo() {
  if(currentVideo){
    currentVideo.pause();
    currentVideo.src = "";
    currentVideo.load();
    currentVideo = null;
  }
  if(currentHls){
    currentHls.destroy(); // stop all streaming and audio
    currentHls = null;
  }
}

function updateFocus() {
  items = document.querySelectorAll(".item");
  items.forEach(i => i.classList.remove("active"));
  if(items[focusIndex]) {
    items[focusIndex].classList.add("active");
    items[focusIndex].scrollIntoView({ behavior:"smooth", block:"center" });
  }
}

document.addEventListener("keydown", e => {
  if(!items.length) return;
  switch(e.key){
    case "ArrowDown":
      items[focusIndex].classList.remove("active");
      focusIndex=(focusIndex+1)%items.length; updateFocus(); break;
    case "ArrowUp":
      items[focusIndex].classList.remove("active");
      focusIndex=(focusIndex-1+items.length)%items.length; updateFocus(); break;
    case "ArrowRight":
    case "Enter": items[focusIndex].click(); break;
    case "Backspace":
    case "Escape": showCategories(); break;
  }
});

loadPlaylist();
</script>
</body>
</html>
